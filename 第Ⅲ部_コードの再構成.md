# 第Ⅲ部/ コードの再構成

コードを大きく変更する技法について

- プログラムの主目的と関係のない「無関係の下位問題」を抽出する
- コードを再構成して、一度に一つのことをやるようにする
- 最初にコードを言葉で説明する。その説明を基にしてきれいな解決策を作る



## 無関係の下位問題を抽出する

無関係の下位問題を抽出する流れ

- 関数やコードブロックを見て「このコードの高レベルの目標は何か？」を自問する
- コードの各行に対して「高レベルの目標に直接的に効果があるのか？あるいは、無関係の下位問題を形決しているのか？」を自問する
- 無関係の下位問題を解決しているコードが相当量あればそれらを抽出して別の関数にする

### ユーティリティコード

組み込みライブラリでは補いきれないが色々な場面で使うことのできるコードは「無関係の下位問題」の古典的な例である。このようなコードは自分で書いて自分の中の組み込みライブラリとして残しておけば、複数のプロジェクトで利用することができる。

### 汎用コードをたくさん作る

上記のようなユーティリティコードは基本的で広く適用可能なので、複数のプロジェクトで再利用できる。このようなコードには簡単に共有できるように特別なディレクトリ(例：`util/`)を用意するとよい。汎用コードは**プロジェクトから完全に切り離されている**ため開発もテストも理解も楽。

### 既存のインタフェースを簡潔にする

「ラップ関数」を作ることでインタフェースを簡潔にすることができる。

- 例：以下は`max_results`という名前のクッキーを読み込みコードである。

  ```javascript
  var max_results;
  var cookies = document.cookie.split(";");
  for (var i = 0; i < cookies.length; i++) {
  	var c = cookies[i];
  	c = c.replace(/^[ ]+/, ''); // 先頭の空白を削除
  	if (c.indexOf("max_results=") === 0)
  		max_results = Number(c.substring(12, c.length));
  }
  ```

  これは非常に汚い。これは関数`get_cookie()`を作ってから以下のように書きなおしたい。

  ```javascript
  var max_results = Number(get_cookie("max_results"));
  ```

  クッキーの値の作成や変更部分も`document.cookie`に正しい構文で値を設定する必要がある。

  ```javascript
  document.cookie = "max_results=50; expires=Web, 1 Jan 2020 20:55:47 UTC; path=/";
  ```

  この例の場合、ここまでしか簡潔化することができない。

  理想は以下のように落とし込めるのがよい。

  ```javascript
  set_cookie(name, value, days_to_expire);
  
  // さらに理想は
  delete_cookie(name);
  ```

  ここでの教訓は「理想とは程遠いインタフェースに妥協することはない」ということ。自分でラッパー関数を用意して、手も足も出ない汚いインタフェースを覆い隠すのだ。



### 必要に応じてインタフェースを整える

### やりすぎは注意

無関係の下位問題を積極的に見つけて抽出するとは言っても、小さな関数を作りすぎると逆に読みにくくなってしまう。あちこちに飛び回る実行パスを追いかけることになるからだ。

新しい関数をコードに追加するとごくわずかに読みにくさのコストが発生する。プロジェクトの他の部分からも再利用できるのであれば小さな関数を追加するのも意味があるが、バランスが大切。



## 一度に1つのことを

一度に複数のことをするコードは理解しにくい。

**カギとなる考え**

> コードは1つずつタスクを行うようにしなければいけない。



一度に１つのタスクをするコードを書くための手順

- コードが行っている「タスク」をすべて列挙する。タスクは小さいものから曖昧なものまで。
- タスクをできるだけ異なる関数に分割する。少なくとも異なる領域に分割する。



### タスクは小さくできる

例として、ブログに設置する投票用ウィジェットがあるとする。ユーザは「アップ(賛成)」と「ダウン(反対)」を投票できる。scoreは全ての投票の合計値。「アップ」は+1点、「ダウン」は-1点。

ユーザがボタンをクリックしたら以下のJavaScriptが呼び出される。

```javascript
vote_change(old_vote, new_vote); // 投票は"Up"・"Down"・""のいずれか
```

以下の関数は、`old_vote`と`new_vote`のすべての組み合わせを考慮して、scoreを更新する

```javascript
var vote_changed = (old_vote, new_vote) => {
	var score = get_score();
	
	if (new_vote !== old_vote) {
		if (new_vote === 'Up') {
			score += (old_vote === 'Down' ? 2 : 1);
		} else if (new_vote === 'Down') {
			score -= (old_vote === 'Down' ? 2 : 1);
		} else if (new_vote === '') {
			score += (old_vote === 'Up' ? -1 : 1);
		}
	}
	
	set_score(score);
};
```

このコードは2つのタスクを一度に行っている。

- old_voteとnew_voteを数値にパースする
- scoreを更新する

2つのタスクを別々に解決すれば読みやすいコードになる。

```javascript
var vote_value = (vote) => {
	if (vote === 'Up') {
		return += 1;
	}
	if (vote === 'Down') {
		rerutn -= 1;
	}
	return 0;
};

var vote_changed = (old_vote, new_vote) => {
	var score = get_score();
	score -= vote_value(old_vote); // 古い値を削除
	score += vote_value(new_vote); // 新しい値を追加
};
```

タスクを分解することで可読性が一気に高まる。



### オブジェクトから値を抽出する

#### 「一度に一つのタスク」を適用する

タスクをどのように分割するかよりも、「分割する」ということが大切。



## コードに思いを込める

> おばあちゃんがわかるように説明できなければ、本当に理解したとは言えない。
>
> 　　　　　　　　　　　　　　　　　　　　　　　　　　　　　____アルバート・アインシュタイン

誰かに複雑な考えを伝えるときには、細かいことまで話過ぎると相手を混乱させてしまう。自分よりも知識が少ない人が理解できるような「簡単な言葉」で説明する能力が大切。自分の考えを凝縮して、最も大切な概念にすることが必要となる。これは誰かに理解してもらうだけでなく、自分の考えをより明確にすることにもなる。

コードも同じ。つまり、コードも「簡単な言葉で」書くべき。

コードをより明確にする簡単な手順

- コードの動作を簡単な言葉で同僚にもわかるように説明する
- その説明の中で使っているキーワードやフレーズに注目する
- その説明に合わせてコードを書く

### ロジックを明確に説明する

簡単な言葉でロジックを説明 -> コードに落とし込む例

- ユーザにページを閲覧する権限があるかどうかを確認して、もし権限がなければ権限がないことをユーザに知らせるページに戻す

```
権限があるのは、以下の２つ。
1) 管理者
2) 文書の所有者(文書がある場合)
その他は、権限がない。
```

```php
if (is_admin_req()) {
	// 権限あり
} elseif ($document && ($document['usename'] == $_SESSION['username'])) {
	// 権限あり
} else {
	return not_authorized();
}
```



問題を声に出して説明するだけで、解決策が見つかることもよくある。この技法を「ラバーダッキング」とも呼ぶ。問題や設計をうまく言葉で説明できないのであれば、何かを見落としているか、詳細が明確になっていないということ。プログラム(あるいは自分の考え)を言葉にすることで明確な形になる。

## 短いコードを書く

**カギとなる考え：**

> 最も読みやすいコードは、何も書かれていないコードだ。

### その機能の実装について悩まないで___きっと必要ないから

プログラマというものは、実装にかかる労力を過小評価するものである。プロトタイプの実装にかかる時間を楽観的に見積もったり、将来的に必要となる保守や文書化などの「負担」時間を忘れたりする。

### 質問と要求の分割

全てのプログラムが、高速で、100%正しくて、あらゆる入力をうまく処理する必要はない。要求を詳しく調べれば問題をもっと簡単にできることもある。そうすれば必要なコードも少なくて済む。

千代田区にある30件の店舗を検索するために「日付変更線をまたいでいるときの処理」や「1マイルあたりの経度に対応した地球の曲率の調整」を考える必要はない。



### コードを小さく保つ

コードをできるだけ小さく軽量に維持するために、君がしなければいけないこと

- 汎用的な「ユーティリティ」コードを作って、重複コードを削除する
- 未使用のコードや無用の機能を削除する
- プロジェクトをサブプロジェクトに分割する
- コードの「重量」を意識し、軽量で機敏にしておく

### 身近なライブラリに親しむ

既存のライブラリで問題を解決できることも多い。ライブラリの機能を熟知して、実際に活用することが大切。**たまには標準ライブラリのすべての関数・モジュール・方の名前を15分かけて読んでみよう**。




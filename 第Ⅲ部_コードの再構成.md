# 第Ⅲ部/ コードの再構成

コードを大きく変更する技法について

- プログラムの主目的と関係のない「無関係の下位問題」を抽出する
- コードを再構成して、一度に一つのことをやるようにする
- 最初にコードを言葉で説明する。その説明を基にしてきれいな解決策を作る



## 無関係の下位問題を抽出する

無関係の下位問題を抽出する流れ

- 関数やコードブロックを見て「このコードの高レベルの目標は何か？」を自問する
- コードの各行に対して「高レベルの目標に直接的に効果があるのか？あるいは、無関係の下位問題を形決しているのか？」を自問する
- 無関係の下位問題を解決しているコードが相当量あればそれらを抽出して別の関数にする

### ユーティリティコード

組み込みライブラリでは補いきれないが色々な場面で使うことのできるコードは「無関係の下位問題」の古典的な例である。このようなコードは自分で書いて自分の中の組み込みライブラリとして残しておけば、複数のプロジェクトで利用することができる。

### 汎用コードをたくさん作る

上記のようなユーティリティコードは基本的で広く適用可能なので、複数のプロジェクトで再利用できる。このようなコードには簡単に共有できるように特別なディレクトリ(例：`util/`)を用意するとよい。汎用コードは**プロジェクトから完全に切り離されている**ため開発もテストも理解も楽。

### 既存のインタフェースを簡潔にする

「ラップ関数」を作ることでインタフェースを簡潔にすることができる。

- 例：以下は`max_results`という名前のクッキーを読み込みコードである。

  ```javascript
  var max_results;
  var cookies = document.cookie.split(";");
  for (var i = 0; i < cookies.length; i++) {
  	var c = cookies[i];
  	c = c.replace(/^[ ]+/, ''); // 先頭の空白を削除
  	if (c.indexOf("max_results=") === 0)
  		max_results = Number(c.substring(12, c.length));
  }
  ```

  これは非常に汚い。これは関数`get_cookie()`を作ってから以下のように書きなおしたい。

  ```javascript
  var max_results = Number(get_cookie("max_results"));
  ```

  クッキーの値の作成や変更部分も`document.cookie`に正しい構文で値を設定する必要がある。

  ```javascript
  document.cookie = "max_results=50; expires=Web, 1 Jan 2020 20:55:47 UTC; path=/";
  ```

  この例の場合、ここまでしか簡潔化することができない。

  理想は以下のように落とし込めるのがよい。

  ```javascript
  set_cookie(name, value, days_to_expire);
  
  // さらに理想は
  delete_cookie(name);
  ```

  ここでの教訓は「理想とは程遠いインタフェースに妥協することはない」ということ。自分でラッパー関数を用意して、手も足も出ない汚いインタフェースを覆い隠すのだ。



### 必要に応じてインタフェースを整える

### やりすぎは注意

無関係の下位問題を積極的に見つけて抽出するとは言っても、小さな関数を作りすぎると逆に読みにくくなってしまう。あちこちに飛び回る実行パスを追いかけることになるからだ。

新しい関数をコードに追加するとごくわずかに読みにくさのコストが発生する。プロジェクトの他の部分からも再利用できるのであれば小さな関数を追加するのも意味があるが、バランスが大切。




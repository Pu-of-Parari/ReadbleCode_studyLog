## 第I部 / 表面上の改善

まず手始めにすることのできる改善方法。

適切な命名、優れたコメント、キレイなフォーマット...これらはプログラムの変更やリファクタリングしなくても「入れ替え」が可能。しかし、**コードのすべての行に影響する**大切なテーマである。

### 名前に情報を詰め込む

名前＝短いコメント

短くても良い名前を付ければ、それだけ多くの情報を伝えることができる。

**カギとなる考え：**

> 名前に情報を詰め込む

#### 明確な単語を選ぶ

「名前に情報を詰め込む」には明確な単語を選ばなければならない。「空虚」はNG。

例えば、「get」はあまり明確な単語ではない。

- メソッドの悪い例：

  ```
  def GetPage(url):
  	・・・
  ```

  「get」という単語が曖昧。ページをどこから取ってくる？ローカルキャッシュから？データベースから？インターネットから？インターネットからなら `DownloadPage()`や `FetchPage()`の方が明確。

- BinaryTreeクラスの悪い例：

  ```
  class BinaryTree {
  	int Size();
  	・・・
  };
  ```

  Size()は何を返す？ツリーの高さ？ノード数？ツリーのメモリ消費量？目的に適した明確な名前を付けるなら、それぞれ `Height()`・`NumNodes()`・`MemoryBytes()`のようにするのが良い。

- Threadクラスの悪い例：

  ```
  class Thread {
  	void Stop();
  	・・・
  }
  ```

  Stopでも良いが、動作に合わせてもっと明確な名前を付けた方がさらに良い。取り消しができない思い操作なら`Kill()`、あとから`Resume()`できるなら、`Pause()`にするなど。

##### もっと「カラフル」な単語を探す

シソーラス(類語辞典)を活用したり、友人にもっといい名前がないかきいて適切な単語を模索してみよう

- カラフルなバージョンの単語例
  - send -> deliver, dispatch, announce, distribute, route
  - find -> search, extract, locate, recover
  - start -> launch, create, begin, open
  - make -> create, set up, build, generate, compose, add, new

ただし、やりすぎには注意。時に違いを考えなくてはいけなくなってしまう。例として、PHPの `explode()`関数は `split()`と何が違う？名前だけでは違いがわからない

**キーとなる考え：**

> 気取った言い回しよりも明確で正確な方がいい。

#### tmpやretvalなど汎用的な名前を避ける

tmp・retval・fooのような名前を付けるのは、「名前のことなんて考えていませんよ」と言っているようなもの。このような空虚な名前ではなく、**エンティティの値や目的を表した名前**を選ぼう。

いい名前 = 変数の目的や値を表すもの。例えば、`vの2乗の合計`の変数名は `sum_squares`にする。こうすれば変数の目的も事前に伝わるし、バグの発見にも役立つ。

ただし、汎用的な名前に意味がないわけではない。

##### tmpについて

- 汎用的な名前をうまく使った例：

  2つの変数をスワップする古典的な操作を考える

  ```
  if (right < left) {
  	tmp = right;
  	right = left;
  	left = tmp;
  }
  ```

  このような場合、tmpという名前で全く問題ない。この変数の目的は、情報の一時的な保管。さらに生存期間はわずか数行。tmpという名前で「この変数にはほかに役割はない」という明確な意味を伝えている。

  つまり、他の関数に渡されたり、何度も書き換えられたりはしない、ということ。

- 汎用的な名前をうまく使えていない例：

  ```
  String tmp = user.name();
  tmp += " " + user.phone_number();
  tmp += " " + user.email();
  ・・・
  template.set("user_info", tmp);
  ```

  生存期間は短いが、この変数で一番大切なことは「一時的な保管」ではないため`tmp`と命名するのはナンセンス。わかりやすくするためには、`user_info`のような名前が良いだろう。

- `tmp_file`や`tmp_data`のように `_`の後ろに種類を記述するのも一つの良いアイデア。

**アドバイス：**

> tmpという名前は、生存期間が短くて、一時的な保管が最も大切な変数にだけ使おう。

##### ループイテレータについて

`i`・`j`・`k`・`iter`などの名前は、汎用的な名前だがこれだけで「ぼくはイテレータです」という意味になるため、インデックスやループイテレータで使用して問題ない。

- (Tips) ループイテレータのインデックスが複数ある時の命名の例

  クラブに所属しているユーザを調べるループを考える

  ```
  for (int i = 0; i < clubs.size(); i++)
  	for (int j = 0; j < clubs[i].members.size(); j++)
  		for (int k = 0; k < users.size(); k++)
  			if (clubs[i].members[k] == users[j])
  				・・・
  ```

  if文にある`members[]`と`users[]`のインデックスが逆になっている。そこだけ見ると問題がなさそうに見えるので、バグを見つけるのは困難。

  イテレータが複数あるときには、インデックスも明確な名前をつけるとよい。i, j, kではなく`club_i`、`members_i`, `users_i`など。もっと簡潔に、`ci`、`mi`,`ui`でもよい。こうすることでバグが見つけやすくなる。

  ```
  if (clubs[ci].members[ui] == users[mi]) ## 最初の文字が一致していないからおかしい！
  if (clubs[ci].members[mi] == users[ui]) ## 最初の文字が一致しているから問題ない！
  ```

**アドバイス：**

> tmp・it・retvalのような汎用的な名前を使うときは、それ相応の理由を用意しよう。

#### 抽象的な名前よりも具体的な名前を使う

変数や関数などの構成要素の名前は、抽象的ではなく具体的なものにしよう。

例えば、`ServerCanStart()`という名前のTCP/IPポートをサーバがリッスンできるか確認するメソッドがあったとする。この名前はちょっと抽象的。`CanListenOnPort()`のように、メソッドの動作をそのまま表す命名の方がより具体的でわかりやすくなる。



#### 名前に情報を追加する

前述のとおり、名前は短いコメントのようなもの。絶対に知らせないといけない大切な情報があれば、「単語」を変数名に追加するようにする。

##### 値の単位

時間やバイト数のように計測できるものであれば、変数名に単位を入れるとよい。

- 単位のない仮引数と単位を追加したよりよい名前の仮引数の例
  - `Start(int delay)`: delay -> delay_secs ## 秒
  - `CreateCache(int size)`: size -> size_mb ## メガバイト
  - `ThrottleDownload(float limit)`: limit -> max_kbps ## kbps
  - `Rorate(float angle)`: angle -> degress_cw ## 度

##### その他の重要な属性を追加する

変数名に追加すべき情報として、単位以外にも「危険や注意を喚起する情報」もある。

- 情報を変数名に追加したほうが良い例

  | 状況                                                       | 変数名   | 改善後             |
  | ---------------------------------------------------------- | -------- | ------------------ |
  | passwordはプレーンテキストなので、処理する前に暗号化すべき | password | plaintext_password |
  | ユーザが入力したcommentは表示する前にエスケープが必要      | comment  | unescaped_comment  |
  | htmlの文字コードをUTF-8に変えた                            | html     | html_utf9          |
  | 入力されたdataをURLエンコードした                          | data     | data_urlenc        |

  全ての変数名に属性を追加する必要はない。変数の意味を間違えたときにバグになりそうなところにだけ使うことが大切。

  特にセキュリティ系のバグのような深刻な被害が出るところに使うとよい。



#### 名前の長さを決める

いい名前を選ぶ時には、「長い名前を避ける」という暗黙的な制約がある。

長すぎても短すぎてもよくない。ではどのあたりに線を引けばよい？それは変数の使い方によって異なる。

##### スコープが小さければ短い名前でもいい

識別子の「スコープ」(その名前が「見える」コードの行数)が小さければ多くの情報を詰め込む必要はない。

```
if (debug) {
	map<string,int> m;
	LookUpNamesNumbers(&m);
	Print(m);
}
```

`m`という変数名には必要最低限の情報しか含まれていないが、コードを理解するのに必要な情報はそのすぐ下1行を見れば完結している。このような場合は`m`で問題ない。

`m`がクラスのメンバ変数やグローバル変数の場合

```
LookUpNamesNumbers(&m);
Print(m);
```

このような場合、`m`の型や目的が不明で読みにくいコードである。識別子のスコープが大きければ、名前に十分な情報を詰め込み明確にする必要がある。



##### 長い名前を入力するのは問題じゃない

たいていのテキストエディタには補完機能があるため、少々名前が長くなってしまっても問題ない。



##### 頭文字と省略形

頭文字や省略形を使って名前を短くすることがある。省略可否の判断はどうすればよいか？

**「新しいチームメイト(将来の自分自身も)がその名前の意味を理解できるかどうか？」**を判断基準にすればまず問題ない。

例えば、`BackEndManager`じゃなくて`BEManager`にする。この場合、`BE = BackEnd` と理解できるのは恐らくプロジェクトメンバのみ。新しいチームメイトは理解できないだろう。プログラマ共通の語、例えば、`evaluation`の代わりに`eval`、`document`の代わりに`doc`、`string`の代わりに`str`のようなものは省略しても良い。

##### 不要な単語は投げ捨てる

名前に含まれる単語を削除しても情報が全く損なわれないこともある。その時は短くしてしまおう。例えば、`ConvertToString()`を短くして`ToString()`にしても必要な情報は何も損なわれない。

#### 名前のフォーマットで情報を伝える

アンダースコア・ダッシュ・大文字を使って名前に情報も詰め込むこともできる。

プロジェクトや言語によって使うフォーマット規約は違ってくる(JavaScriptなら『JavaScript: The Good Parts』、PythonならPEP8など)。規約を使うかどうかは、自分自身やチームで決めるとよい。どんなものを使うにしても、プロジェクトで一貫性を持たせることが大切。
